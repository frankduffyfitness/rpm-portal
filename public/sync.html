<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPM Portal â€” VALD Sync</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0a; color: #e0e0e0; font-family: 'DM Sans', -apple-system, sans-serif; padding: 24px; }
  h1 { font-size: 24px; margin-bottom: 8px; color: #4FFFB0; }
  .sub { color: #888; margin-bottom: 24px; font-size: 14px; }
  .config { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
  .config label { font-size: 13px; color: #aaa; }
  .config input { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 13px; width: 180px; }
  button { background: #4FFFB0; color: #000; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  button.stop { background: #FF6B6B; color: #fff; }
  #log { background: #111; border: 1px solid #222; border-radius: 8px; padding: 16px; margin-top: 16px; max-height: 400px; overflow-y: auto; font-family: 'SF Mono', monospace; font-size: 12px; line-height: 1.8; }
  .log-line { border-bottom: 1px solid #1a1a1a; padding: 2px 0; }
  .log-line.ok { color: #4FFFB0; }
  .log-line.warn { color: #FFD700; }
  .log-line.err { color: #FF6B6B; }
  .log-line.info { color: #60A5FA; }
  .progress { margin-top: 16px; }
  .progress-bar { background: #1a1a1a; border-radius: 8px; height: 24px; overflow: hidden; position: relative; }
  .progress-fill { background: linear-gradient(90deg, #4FFFB0, #60A5FA); height: 100%; transition: width 0.3s; border-radius: 8px; }
  .progress-text { position: absolute; top: 0; left: 0; right: 0; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: #000; }
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 16px; }
  .stat { background: #1a1a1a; border-radius: 8px; padding: 12px; text-align: center; }
  .stat-val { font-size: 24px; font-weight: 700; color: #4FFFB0; }
  .stat-label { font-size: 11px; color: #888; margin-top: 4px; }
  .actions { display: flex; gap: 12px; margin-top: 16px; }
  #download { display: none; }
  .chunk-size { width: 60px !important; text-align: center; }
</style>
</head>
<body>
<h1>âš¡ VALD Data Sync</h1>
<p class="sub">Pulls all ForceDecks data from the VALD API in chunks, then outputs portal-ready JSON.</p>

<div class="config">
  <div>
    <label>API Base URL</label><br>
    <input id="baseUrl" value="" placeholder="https://your-deployment.vercel.app" style="width:340px">
  </div>
  <div>
    <label>Start Date</label><br>
    <input id="startDate" type="date" value="2025-07-01">
  </div>
  <div>
    <label>End Date</label><br>
    <input id="endDate" type="date" value="2026-03-01">
  </div>
  <div>
    <label>Chunk (days)</label><br>
    <input id="chunkDays" type="number" class="chunk-size" value="14" min="7" max="60">
  </div>
</div>

<div class="actions">
  <button id="startBtn" onclick="startSync()">ðŸš€ Start Sync</button>
  <button id="stopBtn" class="stop" style="display:none" onclick="stopSync()">â›” Stop</button>
  <button id="download" onclick="downloadJSON()">ðŸ“¥ Download JSON</button>
</div>

<div class="progress" id="progressWrap" style="display:none">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
    <div class="progress-text" id="progressText">0%</div>
  </div>
</div>

<div class="stats" id="statsWrap" style="display:none">
  <div class="stat"><div class="stat-val" id="statChunks">0</div><div class="stat-label">Chunks Done</div></div>
  <div class="stat"><div class="stat-val" id="statTests">0</div><div class="stat-label">Tests Processed</div></div>
  <div class="stat"><div class="stat-val" id="statCMJ">0</div><div class="stat-label">CMJ Sessions</div></div>
  <div class="stat"><div class="stat-val" id="statHop">0</div><div class="stat-label">Hop Sessions</div></div>
  <div class="stat"><div class="stat-val" id="statAthletes">0</div><div class="stat-label">Athletes</div></div>
  <div class="stat"><div class="stat-val" id="statTime">0s</div><div class="stat-label">Elapsed</div></div>
</div>

<div id="log"></div>

<script>
let running = false;
let mergedProfileMap = {};
let mergedCMJ = {};
let mergedHop = {};
let totalProcessed = 0;

// Auto-detect base URL from current location
(function() {
  const host = window.location.origin;
  if (host && !host.includes('localhost') && !host.includes('file://')) {
    document.getElementById('baseUrl').value = host;
  }
})();

function log(msg, cls = '') {
  const el = document.getElementById('log');
  const line = document.createElement('div');
  line.className = 'log-line ' + cls;
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function updateStats(chunks, elapsed) {
  document.getElementById('statChunks').textContent = chunks;
  document.getElementById('statTests').textContent = totalProcessed;
  document.getElementById('statCMJ').textContent = Object.values(mergedCMJ).reduce((s, a) => s + a.length, 0);
  document.getElementById('statHop').textContent = Object.values(mergedHop).reduce((s, a) => s + a.length, 0);
  document.getElementById('statAthletes').textContent = new Set([...Object.keys(mergedCMJ), ...Object.keys(mergedHop)]).size;
  document.getElementById('statTime').textContent = (elapsed / 1000).toFixed(1) + 's';
}

function mergeData(data) {
  // Merge profileMap
  if (data.profileMap) Object.assign(mergedProfileMap, data.profileMap);
  
  // Merge CMJ
  if (data.cmj) {
    for (const [pid, sessions] of Object.entries(data.cmj)) {
      if (!mergedCMJ[pid]) mergedCMJ[pid] = [];
      mergedCMJ[pid].push(...sessions);
    }
  }
  
  // Merge Hop
  if (data.hop) {
    for (const [pid, sessions] of Object.entries(data.hop)) {
      if (!mergedHop[pid]) mergedHop[pid] = [];
      mergedHop[pid].push(...sessions);
    }
  }
  
  totalProcessed += (data.stats?.processed || 0);
}

function sortAllSessions() {
  const dateCmp = (a, b) => {
    const [am, ad, ay] = a.date.split('/').map(Number);
    const [bm, bd, by] = b.date.split('/').map(Number);
    return (ay - by) || (am - bm) || (ad - bd);
  };
  Object.values(mergedCMJ).forEach(a => a.sort(dateCmp));
  Object.values(mergedHop).forEach(a => a.sort(dateCmp));
}

function deduplicateSessions() {
  // Remove duplicate sessions (same date + same metrics) that may overlap between chunks
  const dedup = (obj) => {
    for (const pid of Object.keys(obj)) {
      const seen = new Set();
      obj[pid] = obj[pid].filter(s => {
        const key = s.date + '|' + (s.jumpHeight || s.rsi || '') + '|' + (s.bodyweightLbs || '');
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }
  };
  dedup(mergedCMJ);
  dedup(mergedHop);
}

async function startSync() {
  const baseUrl = document.getElementById('baseUrl').value.replace(/\/$/, '');
  const startDate = new Date(document.getElementById('startDate').value + 'T00:00:00Z');
  const endDate = new Date(document.getElementById('endDate').value + 'T00:00:00Z');
  const chunkDays = parseInt(document.getElementById('chunkDays').value) || 14;
  
  if (!baseUrl) { alert('Enter your deployment URL'); return; }
  
  // Reset
  mergedProfileMap = {};
  mergedCMJ = {};
  mergedHop = {};
  totalProcessed = 0;
  running = true;
  
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').style.display = '';
  document.getElementById('progressWrap').style.display = '';
  document.getElementById('statsWrap').style.display = '';
  document.getElementById('download').style.display = 'none';
  document.getElementById('log').innerHTML = '';
  
  // Build chunks
  const chunks = [];
  let cursor = new Date(startDate);
  while (cursor < endDate) {
    const chunkEnd = new Date(cursor.getTime() + chunkDays * 24 * 60 * 60 * 1000);
    const end = chunkEnd > endDate ? endDate : chunkEnd;
    chunks.push({ since: cursor.toISOString(), until: end.toISOString() });
    cursor = end;
  }
  
  log(`Starting sync: ${chunks.length} chunks of ${chunkDays} days each`, 'info');
  log(`Range: ${startDate.toISOString().slice(0,10)} â†’ ${endDate.toISOString().slice(0,10)}`, 'info');
  
  const syncStart = Date.now();
  let completed = 0;
  
  for (const chunk of chunks) {
    if (!running) { log('Sync stopped by user', 'warn'); break; }
    
    const label = chunk.since.slice(0,10) + ' â†’ ' + chunk.until.slice(0,10);
    log(`Fetching chunk: ${label}...`);
    
    try {
      const url = `${baseUrl}/api/vald-sync?since=${encodeURIComponent(chunk.since)}&until=${encodeURIComponent(chunk.until)}&v=${Date.now()}`;
      const resp = await fetch(url);
      const data = await resp.json();
      
      if (!data.success) {
        log(`Chunk failed: ${data.error || 'unknown error'}`, 'err');
        continue;
      }
      
      mergeData(data);
      completed++;
      
      const pct = Math.round((completed / chunks.length) * 100);
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressText').textContent = pct + '%';
      updateStats(completed, Date.now() - syncStart);
      
      const cmjS = data.stats?.cmjSessions || 0;
      const hopS = data.stats?.hopSessions || 0;
      const skip = data.stats?.skipped || 0;
      const timedOut = data.complete === false;
      
      log(`  âœ“ ${label}: ${data.stats?.processed} tests â†’ ${cmjS} CMJ, ${hopS} Hop` + 
          (skip ? `, ${skip} squat jumps skipped` : '') +
          (timedOut ? ' âš ï¸ TIMED OUT (some tests missed)' : '') +
          ` [${data.elapsed}]`,
          timedOut ? 'warn' : 'ok');
      
    } catch (err) {
      log(`Chunk error (${label}): ${err.message}`, 'err');
    }
    
    // Small delay between chunks to be nice to VALD API
    await new Promise(r => setTimeout(r, 500));
  }
  
  // Sort and deduplicate
  sortAllSessions();
  deduplicateSessions();
  
  const totalCMJ = Object.values(mergedCMJ).reduce((s, a) => s + a.length, 0);
  const totalHop = Object.values(mergedHop).reduce((s, a) => s + a.length, 0);
  const totalAthletes = new Set([...Object.keys(mergedCMJ), ...Object.keys(mergedHop)]).size;
  const elapsed = ((Date.now() - syncStart) / 1000).toFixed(1);
  
  log('', '');
  log(`â•â•â• SYNC COMPLETE â•â•â•`, 'info');
  log(`${completed}/${chunks.length} chunks processed in ${elapsed}s`, 'info');
  log(`${totalAthletes} athletes Â· ${totalCMJ} CMJ sessions Â· ${totalHop} Hop sessions`, 'ok');
  log(`${totalProcessed} total tests processed`, 'ok');
  
  updateStats(completed, Date.now() - syncStart);
  
  running = false;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('download').style.display = '';
}

function stopSync() {
  running = false;
}

function downloadJSON() {
  const output = {
    syncedAt: new Date().toISOString(),
    stats: {
      cmjAthletes: Object.keys(mergedCMJ).length,
      hopAthletes: Object.keys(mergedHop).length,
      cmjSessions: Object.values(mergedCMJ).reduce((s, a) => s + a.length, 0),
      hopSessions: Object.values(mergedHop).reduce((s, a) => s + a.length, 0),
    },
    profileMap: mergedProfileMap,
    cmj: mergedCMJ,
    hop: mergedHop,
  };
  
  const blob = new Blob([JSON.stringify(output)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vald-sync-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  log(`Downloaded: ${a.download} (${(blob.size / 1024 / 1024).toFixed(1)} MB)`, 'ok');
}
</script>
</body>
</html>
